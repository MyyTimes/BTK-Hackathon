<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Net Ekle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const MAX_TURKCE_NET = {{ MAX_TURKCE_NET | tojson }};
        const MAX_MATEMATIK_NET = {{ MAX_MATEMATIK_NET | tojson }};
        const MAX_FEN_NET = {{ MAX_FEN_NET | tojson }};
        const MAX_INKILAP_NET = {{MAX_INKILAP_NET | tojson }};
        const MAX_DIN_NET = {{MAX_DIN_NET | tojson }};
        const MAX_INGILIZCE_NET = {{MAX_INGILIZCE_NET | tojson }};
        const MAX_TOTAL_NET = {{ MAX_TOTAL_NET | tojson }};
        
        const MIN_TURKCE_NET    = MAX_TURKCE_NET * -0.33;
        const MIN_MATEMATIK_NET = MAX_MATEMATIK_NET * -0.33;
        const MIN_FEN_NET       = MAX_FEN_NET * -0.33;
        const MIN_INKILAP_NET = MAX_INKILAP_NET * -0.33;
        const MIN_DIN_NET = MAX_DIN_NET * -0.33;
        const MIN_INGILIZCE_NET = MAX_INGILIZCE_NET * -0.33;
        const MIN_TOTAL_NET     = MAX_TOTAL_NET * -0.33;
    </script>
</head>
<body>
    <div class="container"> <!-- Ana sayfa ile aynı container sınıfı kullanıldı -->
        <h1>Deneme Netleri Ekle ve Görüntüle</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <div class="section"> <!-- İçerik bir section içine alındı -->
            <form action="{{ url_for('process_new_exam') }}" method="post">
                <div class="form-group">
                    <label for="deneme_adi">Deneme Adı:</label>
                    <input type="text" id="deneme_adi" name="exam_name" required placeholder="Örn: Deneme 1">
                </div>
                <div class="form-group">
                    <label for="turkce_net">Türkçe Neti:</label>
                    <input type="number" id="turkce_net" name="turkce_score" min="{{ MIN_TURKCE_NET }}" max="{{ MAX_TURKCE_NET }}" placeholder="Sayı giriniz..." value="0">
                </div>
                <div class="form-group">
                    <label for="matematik_net">Matematik Neti:</label>
                    <input type="number" id="matematik_net" name="matematik_score" min="{{ MIN_MATEMATIK_NET }}" max="{{ MAX_MATEMATIK_NET }}" placeholder="Sayı giriniz..." value="0">
                </div>
                <div class="form-group">
                    <label for="fen_net">Fen Neti:</label>
                    <input type="number" id="fen_net" name="fen_score" min="{{ MIN_FEN_NET }}" max="{{ MAX_FEN_NET }}" placeholder="Sayı giriniz..." value="0">
                </div>
                <div class="form-group">
                    <label for="inkilap_net">İnkılap Neti:</label>
                    <input type="number" id="inkilap_net" name="inkilap_score" min="{{ MIN_INKILAP_NET }}" max="{{ MAX_INKILAP_NET }}" placeholder="Sayı giriniz..." value="0">
                </div>
                <div class="form-group">
                    <label for="din_net">Din Kültürü Neti:</label>
                    <input type="number" id="din_net" name="din_score" min="{{ MIN_DIN_NET }}" max="{{ MAX_DIN_NET }}" placeholder="Sayı giriniz..." value="0">
                </div>
                <div class="form-group">
                    <label for="ingilizce_net">İngilizce Neti:</label>
                    <input type="number" id="ingilizce_net" name="ingilizce_score" min="{{ MIN_INGILIZCE_NET }}" max="{{ MAX_INGILIZCE_NET }}" placeholder="Sayı giriniz..." value="0">
                </div>

                <div class="button-group">
                    <button type="submit">Netleri Kaydet / Güncelle</button>
                </div>
            </form>

            <a href="{{ url_for('index') }}" class="back-link">Ana Sayfaya Dön</a>
        </div>

        <div class="section charts-container"> <!-- Grafik bölümü de bir section içine alındı -->
            <div class="chart-box">
                <h3 id="currentGraphTitle">Toplam Netler Grafiği</h3>
                <div class="graph-container">
                    <canvas id="lessonNetleriChart"></canvas>
                </div>
                <div class="lesson-buttons">
                    <button class="active" data-lesson="toplam">Toplam</button>
                    <button data-lesson="turkce">Türkçe</button>
                    <button data-lesson="matematik">Matematik</button>
                    <button data-lesson="fen">Fen</button>
                    <button data-lesson="inkilap">İnkılap</button>
                    <button data-lesson="din">Din</button>
                    <button data-lesson="ingilizce">İngilizce</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Grafik Verileri (Excel'den)
        const denemeLabels = {{ deneme_labels | tojson }};
        const turkceNets = {{ turkce_score | tojson }};
        const matematikNets = {{ matematik_score | tojson }};
        const fenNets = {{ fen_score | tojson }};
        const inkilapNets = {{ inkilap_score | tojson }};
        const dinNets = {{ din_score | tojson }};
        const ingilizceNets = {{ ingilizce_score | tojson }};
        const toplamNets = {{ total_score | tojson }};

        // Ders verilerini bir objede topla
        // MAKSİMUM VE MİNİMUM NETLER BURADA GİRİLİ
        const lessonData = {
            "toplam": {
                label: 'Toplam Netler',
                data: toplamNets,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                maxNet: MAX_TOTAL_NET,
                minNet: MIN_TOTAL_NET
            },
            "turkce": {
                label: 'Türkçe Netleri',
                data: turkceNets,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                maxNet: MAX_TURKCE_NET, 
                minNet: MIN_TURKCE_NET 
            },
            "matematik": {
                label: 'Matematik Netleri',
                data: matematikNets,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                maxNet: MAX_MATEMATIK_NET, 
                minNet: MIN_MATEMATIK_NET 
            },
            "fen": {
                label: 'Fen Netleri',
                data: fenNets,
                borderColor: 'rgba(255, 159, 64, 1)',
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                maxNet: MAX_FEN_NET,
                minNet: MIN_FEN_NET 
            },
            "inkilap": {
                label: 'İnkılap Netleri',
                data: inkilapNets,
                borderColor: 'rgba(153, 102, 255, 1)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                maxNet: MAX_INKILAP_NET, 
                minNet: MIN_INKILAP_NET 
            },
            "din": {
                label: 'Din Kültürü Netleri',
                data: dinNets,
                borderColor: 'rgba(87, 255, 109, 1)',
                backgroundColor: 'rgba(27, 134, 23, 0.2)',
                maxNet: MAX_DIN_NET,
                minNet: MIN_DIN_NET
            },
            "ingilizce": {
                label: 'İngilizce Netleri',
                data: ingilizceNets,
                borderColor: 'rgba(255, 102, 102, 1)',
                backgroundColor: 'rgba(204, 21, 21, 0.2)',
                maxNet: MAX_INGILIZCE_NET, 
                minNet: MIN_INGILIZCE_NET
            }
        };

        const ctx = document.getElementById('lessonNetleriChart').getContext('2d');
        let currentChart; // Grafiği tutacak değişken

        // Grafiği çizme fonksiyonu
        function drawChart(lessonKey) {
            if (currentChart) {
                currentChart.destroy(); // Mevcut grafiği yok et
            }

            const lessonInfo = lessonData[lessonKey];
            document.getElementById('currentGraphTitle').innerText = lessonInfo.label + ' Grafiği';

            currentChart = new Chart(ctx, {
                type: 'line', // 'bar' da olabilir
                data: {
                    labels: denemeLabels,
                    datasets: [{
                        label: lessonInfo.label,
                        data: lessonInfo.data,
                        borderColor: lessonInfo.borderColor,
                        backgroundColor: lessonInfo.backgroundColor,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointBackgroundColor: lessonInfo.borderColor,
                        pointBorderColor: lessonInfo.borderColor,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: lessonInfo.minNet,
                            max: lessonInfo.maxNet,
                            ticks: {
                                precision: 1 // Float: 1 Int: 0
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Butonlara olay dinleyici ekle
        document.querySelectorAll('.lesson-buttons button').forEach(button => {
            button.addEventListener('click', function() {
                // Tüm butonlardan 'active' sınıfını kaldır
                document.querySelectorAll('.lesson-buttons button').forEach(btn => btn.classList.remove('active'));
                // Tıklanan butona 'active' sınıfını ekle
                this.classList.add('active');

                const lesson = this.dataset.lesson;
                drawChart(lesson); // Seçilen dersin grafiğini çiz
            });
        });

        // Sayfa yüklendiğinde varsayılan olarak "Toplam" grafiğini çiz
        document.addEventListener('DOMContentLoaded', () => {
            drawChart('toplam');
        });

    </script>
</body>
</html>